History and bug fixes for BPP

Ziheng Yang


If you have questions, please visit the BPP discussion site
http://sourceforge.net/p/bpandp/discussion/.



BP&P, Version 3.4c, July 2021

The option heredity = 1, which estimates the heredity scalars from the
data, is not working correctly, whether theta is integrated out or
not.  It seems that this option never worked before.  

I added options to produce PHASEd alignments and RANDOM alignments.  
When
   int print_random_phase = 1;
and phase = 1 for some species, the program prints out a set of files with heterozygous 
sites phased at random.  It also prints out locus1.fas, locus2.fas, etc. which can be used
to runPHASE to generate the PHASEd alignments.  But this involves changing the source code.



BP&P, Version 3.4a, September 2018

The simulation program MCcoal is broken as the function reading the
tree from the control file failed to read the theta values, so that
the printout on the monitor has -1 for theta.  This is now fixed.



BP&P, Version 3.4, March 2018

I have added and updated an option of analyzing unphased sequences
(control variable diploid), that was initially introduced in bpp 4.0,
but that version has two bugs.  First, if some loci have phased
sequences only, the program does not process the data correctly.
Second, if unphased sequences are before phased sequences at a locus,
the data are not processed correctly.  The program is correct if all
sequences are unphased, if all sequences are phased, and if the phased
sequences are before the unphased sequences.  The symptom is that the
log likelihood values printed on the screen will be incorrect.  The
bugs are fixed now.  If in doubt, please rerun the analysis.

I have also upgraded the program to version 3.4, leaving the version
number 4.0 for the rewritten version that is distributed at github.



BP&P, Version 4.0, December 2017

I have implemented inverse gamma priors for theta's and tau's.  The
following specify similar weak priors, with mean 0.002 for theta and
0.001 for tau, in the two versions.

In bpp3:
    thetaprior = 2 1000    # gamma(a, b) for theta
      tauprior = 2 2000    # gamma(a, b) for root tau 
bpp4:
    thetaprior = 3 0.004   # invgamma(a, b) for theta
      tauprior = 3 0.002   # invgamma(a, b) for root tau

    thetaprior = 3 0.004 E  # invgamma(a, b) for theta.  this estimates theta, like bpp3 for inverse gamma
      tauprior = 3 0.002   # invgamma(a, b) for root tau

The program now has two options, with theta's either estimated in the
MCMC or integrated out analytically.  the gamma priors on theta and
tau are not in bpp4.



BP&P, Version 3.3a, March 2017

A bug was introduced in bpp 3.3 which causes the program to hang in
analysis of sequence data from one single species.  Version 3.2a and
earlier seem fine.  This is now fixed.



BP&P, Version 3.3, November 2016

Dr Tomas Flouri added code to use SSE3 or AVX on new chips to
vectorize some of the calculations in bpp.  In our tests, we have seen
a typical reduction of running time by a half.  See the README.txt
file for instructions for compiling the program to use AVX or SSE.
AVX is newer than SSE.  If you run bpp_AVX and get the following error message:
"Illegal instruction"
most likely your machine does not support AVX, in which case use bpp_SSE.
Thanks to Tomas.

I have added marginal likelihood calculation, using Gaussian-Legendre
quadrature, as decribed in Rannala & Yang (2016 Syst Biol).  A driver
program BFdriver.c is included in the src/ folder.  This can be used
on a linux system running SUN grid engine to submit jobs (with
commmands like qsub, qstat, qdel etc.).




BP&P, Version 3.2a, February 2016

For analysis A11 (speciesdelimitation = 1, speciestree = 1), BPP
sometimes hangs after the MCMC is finished and after it prints out the
following on the screen:

"Summarizing the species-tree sample in file mcmc.txt".

This is due to a bug in the function for summarizing the mcmc sample.  This
bug has been in Versions 3 (May 2014), 3.1, 3.1c, 3.2.  It is now
fixed.



BP&P, Version 3.2, October 2015

This implements a NodeSlider move to improve the mixing of bpp when the spoecies tree
is changing.  Changes to the species tree are now proposed using two algorithsms, the 
SPR and the NodeSlider.  The specifications are 

    speciestree = 0 * species tree fixed
    speciestree = 1  0.4 0.2 0.1   * speciestree pSlider ExpandRatio ShrinkRatio

Here ExpandRatio = 0.2 means that the excess for new tau_Y is 0.2*tau_X.  
ShrinkRatio = 0.1 means that 90% of the density for the new age tau_Y is within 10% of tau_B.  

The old line 
speciestree = 1
uses the default values as
      if(mcmc.usedata) { mcmc.pSlider=0.4; mcmc.ExpandRatio=0.15; mcmc.ShrinkRatio=0.1; }
      else             { mcmc.pSlider=0.4; mcmc.ExpandRatio=0.40; mcmc.ShrinkRatio=0.5; }




BP&P, Version 3.1a, September 2015

(a) MCcoal (the simulation program distributed as part of bpp).  The
locusrate variable in does not work as intended.  

     locusrate = 2.0     * alpha for gamma for locus rate

The parameter (a = 2.0 here) is supposed to be the gamma shape
parameter, so that the rate for each locus is an i.i.d. variable from
G(a, a), with mean 1.  Instead the rates generated by the simulation
program are from G(a, 1), with mean a.  I have now fixed this and also
changed the independent-gamma model into the dirichlet model as
described in Burgess & Yang (2008), so that now both MCcoal and bpp
implements the same dirichlet model of rates for loci.  The inference
program bpp seems to be correct with its implementation of the
dirichlet model.

(b) For analysis A00 (speciesdelimitation=0, speciestree=0) and when
there are more than 10 species, the program identifies the tau and
theta parameters using node numbers, instead of concatenated species
names for ancestors (internal nodes in the species tree).  It is
possible to work out the node numbers from the pop-pop table printed
on the screen, but it is tedious.  I have changed the code to print
out the species tree with node numbers on the screen.  The number 10
is changed to the default value 20.  If you want to change the value,
please edit the following line in bpp.c and recompile.

#define NPopLongNames 20         /* Node numbers are used if more than 20 species */




BP&P, Version 3.1, March 2015

(a) An SPR move is implemented to replace the NNI proposal (which is
described in Yang & Rannala 2014 Mol Biol Evol 31:3125-3135) for
moving between species tree.  This sometimes helps with the mixing
when you have a large number of populations (>10, say).

(b) You can now run the program to summarize the MCMC sample,
bypassing the MCMC.  This is specified by using print = -1 (1 means
regular MCMC with the sample written in the mcmc.txt file).  This is
useful when you want to combine samples from multiple runs into one
sample for summary.

(c) Yang and Rannala (2014 MBE) implemented two priors for models (of
species delimitation and species phylogenies), called Priors 0 and 1.
They also discussed two priors that assign uniform probabilities for
the number of species (1/s each for 1, 2, ..., s species given s
populations).  These are now implemented and called Priors 2 and 3.
Prior 3 may be suitable when there is a large number of populations.

speciesmodelprior = 3  : use 0 1 2 3 for Priors 0 1 2 3.  

Priors 2 and 3 are described in Yang (2015 Curr Zool 61:854-865).



BP&P, Version 3, May 2014

The variable name uniformrootedtrees is changed to speciesmodelprior.
The default value 1 means Prior 1, which assigns equal probabilities
to rooted trees (rather than to labeled histories).

The program now allows changes to the species tree topology through an
NNI move.  This is specified using speciestree = 1.  This can be
combined with species delimitation (speciesdelimitation = 1).  The
document has also been updated.  

Both changes are described in Yang & Rannala (2014 MBE 31:3125-3135).


BP&P, Version 2.2, December 2012

(*) This version includes a few improvements to the rjMCMC algorithms, by 
removing the upper bounds on the new tau in the split move and then 
modifying the gene trees using a rubber-band proportional scaling move
to remove incompatibilities between the gene trees and the new tau.  
We also added a new prior of species-delimitation models specified using 
probabilities for nodes.  The changes are described in an ms. in preparation.

(*) A bug causes both 0 and 1 for uniformrootedtrees to specify the model
of uniform rooted trees (default), although 0 is supposed to mean the
prior used by Yang and Rannala (2010, fig. 1), which specifies uniform
labeled histories.  This bug is in versions 2.0, 2.1, 2.1a and 2.1b,
and is now fixed.

uniformrootedtrees = 1         * 1 means uniform rooted trees (default)
uniformrootedtrees = 0         * 0 means uniform labeled histories

(*)
The variable 

uniformrootedtrees = 1         * 1 means uniform rooted trees (default)

in the control file is now changed to

speciesmodelprior = 1         * 0: uniform labeled histories; 1:uniform rooted trees; 2:user probs

(*) The internal species tree representation has changed, allowing a greater number
of species/populations on the guide tree.




BP&P, Version 2.1c, December 2012 

(*) rjMCMC Algorithm 0 was noted not to work well when epsilon (see
equations 3 & 4 in YR2010) is small, so we recommended the use of
large values.  We then discovered that this was an error (rather than
poor mixing), which causes the posterior model probabilities to be
incorrect (with too much probabilities on the tree models of few
species) if epsilon is small.  The error has an impact when epsilon is
small and virtually no effect when epsilon is large.  This error is
now fixed so you can use smaller values for epsilon such as 0.5, 1, or
2, to maximize the acceptance proportions of between-model moves.  If
you used large epsilon in your analysis using the earlier versions and
the results between Algorithms 0 and 1 were very similar, the results
should be fine.

 speciesdelimitation = 1 0 10    * speciesdelimitation algorithm0 and finetune(e)


BP&P, Version 2.1b, April 2012

If heredity = 1 or locusrate = 1, the program may crash due to errors in memory allocation.  
The bug is because I could not make up my mind whether to print the locus rate or heredity 
scalars.  This is now fixed.



BP&P, Version 2.1a, July 2011

MCcoal.  The simulation algorithm is found to contain a bug.  The line in the routine 
CoalescentMigration()

            if(k2==k1) k2++;

should have been 

            if(k2>=k1) k2++;

The bug causes the sequences not to coalesce at random if 3 or more
lineages are in the same population, with the first few sequences
coalescing at too high probabilities.  The bug causes the different
gene tree topologies to be sampled with incorrect probabilities,
although the coalescent times are correct.  The impact of the bug is
somewhat hard to assess.  It is noted that the bug causes the
parameter estimates under Model 0 to be biased.

This bug affects MCcoal in bpp versions 2.0 (June 2010), 2.0a, 2.0b,
and 2.1.  The simulation program in MCMCcoal (Version 1.2a, October
2010 or earlier) is correct.  This is now fixed.  



BP&P, Version 2.1, April 2011

(a) bpp.  I have changed the specification of the finetune variable to allow
the program to use automatic adjustment.  The old option of using
fixed step lengths is specified by

      finetune = 0: .05 .001 .0003 .0005 .08 .25 0.0002  # finetune for GBtj, GBspr, theta, tau, mix, locusrate, seqerr

while the new option of automatic steplength adjustment is specified
by someething like the following.  The step lengths on the line are
still used as initial values, but bpp will try to use the burn in to
make adjustments.

      finetune = 1: .01 .01 .01 .01 .01 .01 .01 .01  # finetune for GBtj, GBspr, theta, tau, mix, locusrate, seqerr

Look at the document.

(b) bpp.  A bug that affects the posterior summary of parameters for
the MAP tree is fixed.  With species delimitation, the different
species models have different numbers of parameters.  At the end of
the MCMC run, the program identifies the MAP tree, the species tree
model with the maximum posterior probability, and then copies the
samples of parameters for that model from the MCMC sample file into
another temporary file mcmc.tmp, and summarizes the results for the
MAP tree.  I think this was added in version 2.0a or b.  A bug in the
program (versions 2.0, 2.0a, 2.0b) caused the program to count the
number of parameters incorrectly if the last species tree visited
during the MCMC is not the MAP tree.  As a result, no summary is
provided for the MAP tree or 0s are shown for the posterior means, CIs
etc. for the MAP tree.  This bug is now fixed.  Thanks to Chih-Ming
Hung for reporting the bug.

In general, a better way of generating the posterior of parameters for
the MAP tree is to turn off speciesdelimitation and use the MAP tree
as the fixed species tree.  This requires preparing new control and
Imap files although there is no need to change the sequence alignment
file.

(c) bpp.  Restored the option of specifying heredity multipliers
(heredity = 2).  This option was in MCMCcoal but disabled when I
changed the sequence data file format.  In this version the
multipliers are specified in a file.  I have yet to do some testing of
this option.




BP&P, Version 2.0b, November 2010

MCcoal.  The simulation algorithm for simulating data under a model of
migration is found to have bugs.  These are now fixed.


BP&P, Version 2.0a, August 2010

The definition of the migration matrix in the control file MCcoal.ctl
for the simulation program is now changed.  In version 2.0, Mij = mij/
mu, where mij is the proportion of migrants in population j that are
from population i and is the mutation rate per site per generation.
This scaling by the mutation rate is not so intuitive biologically.
From version 2.0a, Mij = Nj*mij, that is, the expected number of
migrants in population j that are from population i.  This seems to be
more intuitive.



BP&P, Version 2.0, June 2010

Implemented the algorithm of Yang & Rannala (2010) for species delimitation.  

The priors on tau's and theta's are now slightly different from those
used in MCMCcoal.  In bpp, all s in the model are assigned gamma
priors with the same parameters, while in MCMCcoal one has to specify
a gamma prior for each parameter, so the parameters can be different.
In bpp, the root age in the species tree (tau_0) is assigned a gamma
prior, while the other node ages are generated from the Dirichlet
distribution (Yang and Rannala, 2010: equation 2).  We suspect that
those differences should not matter much in typical datasets.



MCMCcoal, Version 1.2, July 2007

Added two models of mutation rate variation among loci: one using
fixed locus rates estimated externally, and another of random variable
rates across loci (with a transformed Dirichlet prior).  See Burgess &
Yang (2008).

Added two options for locus-specific heredity multipliers (inheritance
scalars).  The first is for the user to specify the multipliers in the
sequence data file, which will be used in the likelihood calculation
in the MCMC.  The second is to let the program estimate the
multipliers, with a gamma prior.  Those options are not tested
carefully.

The definition of species divergence times is changed.  In version 1.1
and earlier, the divergence times may be defined as time gaps (say,
HCGO - HCG, HCG - HC, and HC) or as ages of nodes in the species tree
(say, HCGO, HCG, HC).  This definition affects the prior specification
and the output.  In version 1.2, the parameters are always defined as
node ages, in both prior specification and output.

Added a model of random sequencing errors.  This assumes that some
species have sequencing errors, with a constant per-nucleotide error
rate applied to all sequences for that species.



MCMCcoal, Version 1.1, April 2005


MCMCcoal, Version 1.0, September 2002

This program implements the MCMC coalescent model of Rannala & Yang (2003 Genetics 164:1645-1656).

// end of file
